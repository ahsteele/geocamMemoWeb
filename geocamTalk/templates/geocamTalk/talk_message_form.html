{% extends "talk_base.html" %}

{% block content %}

<script>
	setInterval("setTheTime()", 1000);
	function setTheTime () {
		var curtime = new Date();
		var curhour = curtime.getHours();
		var curmin = curtime.getMinutes();
		var cursec = curtime.getSeconds();
		var time = "";
		if(curhour == 0) curhour = 12;
		time = (curhour > 12 ? curhour - 12 : curhour) + ":" +
		(curmin < 10 ? "0" : "") + curmin + ":" +
		(cursec < 10 ? "0" : "") + cursec + " " +
		(curhour > 12 ? "PM" : "AM");
		$('#time').html(time);
	}
	
	function error(msg) {
   		$('#status').html(msg);
	}


	function success(position) {
		$('#status').html('Geolocation was successful.');
  		$('input[name="latitude"]').val(position.coords.latitude).attr({readonly:true});
  		$('input[name="longitude"]').val(position.coords.longitude).attr({readonly:true});
  		$('input[name="altitude"]').val(position.coords.altitude).attr({readonly:true});
  		$('input[name="accuracy"]').val(position.coords.accuracy).attr({readonly: true});
  		$('input[name="heading"]').val(position.coords.heading).attr({readonly:true});
  		$('input[name="speed"]').val(position.coords.speed).attr({readonly:true});
  		$('input[name="position_timestamp"]').val(position.timestamp).attr({readonly:true});
	} 
    
	$(document).ready(function() {
  		    $('select[name="author"]').val({{ user.pk }}).attr({disabled:true});
			if (navigator.geolocation) {
		  		navigator.geolocation.getCurrentPosition(success, 
		  						error('Geolocating...'));
			} else {
		  		error('Geolocation is not supported.');
			}
		});
</script>

{% if form.errors %}
<div id="form-error">
  <p>The operation could not be performed because one or more error(s) occurred.<br />Please resubmit the form after making the following changes:</p>
  <ul>
  {% for field in form %}
	 {% if field.errors %}<li>{{ field.label }} {{ field.errors|striptags }}</li>{% endif %} 
  {% endfor %}
  </ul>
</div>
{% endif %}

<p><div id='status'></div></p>
<p>Current time: <div id='time'></div></p>
<form action="/talk/messages/create/" method="post">
	{% csrf_token %}
	<table>
        <tr>
        <td>{{ form.content.label_tag }}</td>
        <td>{{ form.content }}</td>
        </tr>
	</table>
	<input type="hidden" name="author" value="{{ user.pk }}" />
	<input type="hidden" name="latitude" value="{{ form.latitude }}" />
	<input type="hidden" name="longitude" value="{{ form.longitude }}" />
	<input type="hidden" name="altitude" value="{{ form.altitude }}" />
	<input type="hidden" name="accuracy" value="{{ form.accuracy }}" />
	<input type="hidden" name="heading" value="{{ form.heading }}" />
	<input type="hidden" name="speed" value="{{ form.speed }}" />
	<input type="hidden" name="position_timestamp" value="{{ form.position_timestamp }}" />
	<input type="submit" value="Send Message" />
</form>

{% endblock %}