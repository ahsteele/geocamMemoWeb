{% extends "geocamTalk/base.html" %}

{% block title%}GeoCam Talk Messages{% endblock %}

{% block content %}
<h1>
	{% if recipient != None and author != None %}
		Messages to
		{% if recipient == user %}
			me
		{% else %}
			{{recipient.full_name}}
		{% endif %}
		from
		{% if author == user %}
			me
		{% else %}
			{{author.full_name}}
		{% endif %}
	{% else %}
		{% if recipient != None %}
			{% if recipient == user %}
				My
			{% else %}
				{{recipient.full_name}}'s
			{% endif %}
			messages
		{% else %}
			All Messages
		{% endif %}
	{% endif %}
</h1>
<div id="messages">
<dl id="message_list">
{% for m in gc_msg %}
	<dt id="message_{{m.pk}}">
	  On {{ m.get_date_string }}
	  {% if recipient %} 
	  <a href="{% url geocamTalk.views.message_list recipient.username m.author.username %}"> 
          {{ m.get_author_string}}</a>
      {% else %}
          {{ m.get_author_string}}
      {% endif %}
	 	said
	  {% if m.has_geolocation %}<a data-rel="dialog" data-transition="pop" data-inline="true" data-role="button" data-icon="geoCam-map" data-iconpos="notext">Map Info</a>{%endif%}
	  {% if m.has_audio %}
          <a class="media" href="{{m.audio_file.url}}"></a>
      {%endif%}
	</dt>
	<dd id="message_{{m.pk}}_content">
    	<p>{{ m.content}}</p>
	</dd>
{% endfor %}
</dl>

<a href="{% url geocamTalk.views.create_message %}">New Message</a>
</div>
{% endblock %}

{% block js %}
<script>
	$(document).ready(function() {
                $('a.media').media( { width: 300, height: 20 } );
		var running_timestamp = {{ timestamp }};
		var new_message_count = {{ user.profile.getUnreadMessageCount }};
		
		var updateFunction = function(){
			// messagefeed.json looks like this:
	        // [{"content": "The hospital is full, no more beds...", "content_timestamp": "02/19 21:35:52", "has_geolocation": -122.4048743, "author": "Adam Grant"}, 
	        //  {"content": "Casualties are littering the streets!", "content_timestamp": "02/19 21:35:29", "has_geolocation": -122.4048743, "author": "Adam Grant"}, 
	        //  {"content": "Some crazy stuff is happening in this neighborhood.", "content_timestamp": "02/19 21:34:46", "has_geolocation": -122.4048743, "author": "Adam Grant"}]
	        {% if author %}
	        	var url = '{% url geocamTalk.views.feed_messages recipient.username author.username %}';
	        {% else %}
	        	{% if recipient %}   
	        		var url = '{% url geocamTalk.views.feed_messages recipient.username %}';
	        	{% else %}   
	        		var url = '{% url geocamTalk.views.feed_messages %}';
	        	{% endif %}
	        {% endif %}
	        url = url + '?since=' + running_timestamp;
	        $.getJSON(url, function(data) {
	            var html_str = "";	
	        	for (var i in data['ms']) {
	        		var msg = data['ms'][i];
	        		var pk = msg['messageId'];
	        		var content = msg['content'];
	        		var content_timestamp = msg['contentTimestamp']; // TODO: convert this to a string
	        		var has_geolocation = msg['hasGeolocation'];
	        		var authorUsername = msg['authorUsername'];
	        		var authorFullname = msg['authorFullname']
	        		{% if recipient %}
	        		    authorFullname = '<a href="{% url geocamTalk.views.message_list recipient.username %}/' +authorUsername+ '">' +authorFullname+ '</a>' ;
	        		{% endif %}
	        		
	        		html_str += '<dt id="message_'+pk+'">';
	        		html_str += 'On '+content_timestamp+' '+authorFullname+' said';
	        		if (has_geolocation == true) {
	        			html_str += '<a data-rel="dialog" data-transition="pop" data-inline="true" data-role="button" data-icon="geoCam-map" data-iconpos="notext">Map Info</a>';
	        		}
	        		html_str += '</dt>';
	        		html_str += '<dd id="message_'+pk+'_content">';
	        		html_str += '<p>'+content+'</p>';
	        		html_str += '</dd>';
	        	}
	        	
	        	$.mobile.activePage.page().find('#message_list').prepend(html_str);
	        	running_timestamp = data['ts'];
	        	new_message_count += data['msgCnt'];
	        	$.mobile.activePage.page().find('#new_message_count').html(new_message_count);
	        	
	        	if (new_message_count > 0
                    && $.mobile.activePage.page().find('#clear_link').length == 0)
	        	{
	        		//var span = '<span id="stupidfix">&nbsp;</span>';
	        		var link = $('<li><a id="clear_link" href="#">(Clear)</a></li>');
	        		link.click(function() {
	        			$.get('{% url geocamTalk.views.clear_messages %}', function() {
	        				new_message_count = 0;
	        				$.mobile.activePage.page().find('#new_message_count').html(new_message_count);
	        				$.mobile.activePage.page().find('#clear_link').remove();
	        			});
	        		});
	        		$.mobile.activePage.page().find('#my_messages_link').parent().after(link);//.after(span);
	        		//alert($('#bigSigh'));//.listview('refresh');
	        	}
	        });
		}; 
		updateFunction();
		setInterval(updateFunction, 3*1000);
	});
</script>
{% endblock %}
